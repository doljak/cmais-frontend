<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8">
    <title> · Segunda Tela · </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="../docs/assets/css/bootstrap.css" rel="stylesheet">
    <link href="../docs/assets/css/bootstrap-responsive.css" rel="stylesheet">

    <link href="../docs/assets/css/docs.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="../img/favicon.png">

    <style type="text/css">
      #title { 
        margin-top: 13px;
      }
      #preview { 
        margin-top: 13px;
      }
      #preview img {
        width: 40%;
        float: left;
        margin-right: 13px;
      }
      #new-content-tag{
        padding-right: 35px;
        /* background-image: url('../img/loading6.gif'); */
        background-repeat: no-repeat;
        background-position: right;
      }
      .ui-autocomplete-loading { background: white url('../img/loading6.gif') right center no-repeat; }
      .loading { background: white url('../img/loading6.gif') right center no-repeat; }
      .autocomplete-suggestions { border: 1px solid #999; background: #FFF; cursor: default; overflow: auto; }
      .autocomplete-suggestion { padding: 2px 5px; white-space: nowrap; overflow: hidden; }
      .autocomplete-selected { background: #F0F0F0; }
      .autocomplete-suggestions strong { font-weight: normal; color: #3399FF; }
    </style>
  </head>

  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/" style="float: left; margin-top: 5px;"> · Segunda Tela · </a>

          <div id="status" class="pull-right" style="margin-left: 5px; margin-top: 5px">
            <a class="btn btn-danger disabled">
              Offline
            </a>
          </div>

          <div class="btn-toolbar pull-right" style="margin-right: 15px;">
            <div class="btn-group">
              <a id="admin" class="btn btn-warning btn-mini"><i class="icon-refresh icon-white"></i> Refresh</a>
            </div>
            <div class="btn-group hide">
              <a id="restart" class="btn btn-primary btn-mini"><i class="icon-refresh icon-white"></i> Restart</a>
              <a id="stop" class="btn btn-primary btn-mini"><i class="icon-stop icon-white"></i> Stop</a>
              <a id="start" class="btn btn-primary btn-mini"><i class="icon-play icon-white"></i> Start</a>
            </div>
          </div>

        </div>

      </div><!-- /navbar-inner -->
      
    </div>
    
    
    <div class="container-fluid">
      
      <div class="row-fluid server-status hide">
        
        <div class="span3">
          <div class="page-header">
            <h2>Server Info</h2>
          </div>
          <div id="serverInfo" class="pull-left2">
            <p>Host: <span id="host">astolfo</span></p>
            <p>Port: <span id="port">9999</span></p>
            <p>Check origin: <span id="check">No</span></p>
            <p>Connected Clients: <span id="clientCount"></span></p>
            <p>Limit Clients: <span id="maxClients"></span></p>
            <p>Limit Connections/IP: <span id="maxConnections"></span></p>
            <p>Limit Requetes/Min: <span id="maxRequetsPerMinute"></span></p>
          </div>
        </div>
        
        <div class="span4">
          <div class="page-header">
            <h2>Clients <small id="nun_clients"></small></h2>
          </div>
          <table class="table table-striped table-hover" id="clientTable" style="height: 230px; overflow: auto; display: block;">
            <thead>
              <tr>
                <th>ID</th>
                <!-- <th>Actions</th> -->
              </tr>
            </thead>
            <tbody id="clientTableBody"></tbody>
          </table>
        </div>
        
        <div class="span5">
          <div class="page-header">
            <h2>Messages</h2>
          </div>
          <div id="log2" style="margin: 6px 0 10px 0; padding: 5px; border: 1px solid red; height: 215px; overflow: auto; -webkit-border-radius: 3px; -moz-border-radius: 3px; border-radius: 3px;"></div>
        </div>

      </div>

      <div class="row-fluid contents">
        <div class="span12">

          <div style="display: block;">
            <a id="new-content-btn" class="btn btn-mini btn-primary pull-right"><i class="icon-plus icon-white"></i> Add New Content</a>

            <div id="new-content" class="hide" style="display: none; margin-bottom: 100px; margin-top: 10px;">
              <form class="form-inline" onsubmit="return false">
                <input type="hidden" id="new-content-mode" value="search" />
                <input type="hidden" id="new-content-source" value="" />
                <input type="hidden" id="new-content-id" value="" />
                
                <ul id="form-tab" class="nav nav-tabs">
                  <li class="active"><a href="#search" data-toggle="tab">Search</a></li>
                  <li><a href="#create" data-toggle="tab">Create</a></li>
                </ul>

                <div class="controls">
                  <select id="new-content-type" class="input-medium">
                    <option value="content">Conteúdo</option>
                    <option value="people">Pessoa</option>
                    <option value="place">Lugar</option>
                    <option value="poll">Enquete</option>
                  </select>
                </div>
                <a id="preview-a"></a>
                <div id="preview-w" class="hide">
                  <div class="page-header">
                    <h3>Preview</h3>
                  </div>
                  <div id="title" class="hide"><input type="text" id="new-content-title" class="input-xxxlarge" autocomplete="off" /></div>
                  <div id="preview" style="display: inline-block;"></div>
              </div>

  
                <div class="tab-content">
                  <div class="tab-pane active" id="search">
                    <input type="text" id="new-content-tag" class="input-xxlarge typeahead" placeholder="tag or slug" autocomplete="off" />
                  </div>
                  <div class="tab-pane" id="create">
                    <div class="controls">
                      <input type="text" id="new-content-tag-c" class="input-xxlarge" placeholder="Title" autocomplete="on" style="margin-top: 2px;margin-bottom: 2px;" />
                      <textarea id="new-content-html-c" class="ckeditor" style="width: 100%; height: 350px;"></textarea>
                    </div>
                  </div>
                </div>
              </form>

              <hr />
              <div class="controls" style="clear: both;">
                <img id="fetching" src="../img/loading6.gif" alt="loading" class="hide" />
                <a href="#preview-a" id="new-content-preview" class="btn btn-mini btn-primary disabled" style="display: none;"><i class="icon-check icon-white"></i> Preview</a>
                <a id="new-content-edit" class="btn btn-mini btn-warning" style="display: none;"><i class="icon-pencil icon-white"></i> Edit</a>
                <a id="new-content-save" class="btn btn-mini btn-success disabled"><i class="icon-ok icon-white"></i> Save</a>
                <a id="new-content-cancel" class="btn btn-mini btn-danger"><i class="icon-remove icon-white"></i> Cancel</a>
              </div>
              
            </div>

            <div class="page-header">
              <h3>Content List</h3>
            </div>

            <table class="table table-hover table-condensed">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Source</th>
                  <th>Type</th>
                  <th>Title</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="content-list"></tbody>
            </table>

            <!--<div id="content-list" style="margin-top: 25px;"></div>-->

          </div>

        </div>
      </div>
      
      <script src="../docs/assets/js/jquery.js"></script>
      <script src="../docs/assets/js/bootstrap-tab.js"></script>
      <script src="../js/jquery.autocomplete.js"></script>
      <script src="../js/json2.js"></script>

      <!-- CLIENT -->
      <script>
      function initClient(){
        var log2, serverUrl2, socket2;
        log2 = function(msg) {
          //$('#log2').append("" + msg + "<br />");
          $log2 = $('#log2');
          //Add text to log2
          $log2.append(($log2.val()?"<br />":'<br />')+msg);
          //Autoscroll
          $log2[0].scrollTop = $log2[0].scrollHeight - $log2[0].clientHeight;
          return true;
        };
        
        serverUrl2 = 'ws://200.136.27.32:80/secondscreen';
        //serverUrl2 = 'ws://ss:8080/secondscreen';
        if (window.MozWebSocket) {
          socket2 = new MozWebSocket(serverUrl2);
        } else if (window.WebSocket) {
          socket2 = new WebSocket(serverUrl2);
        }
        
        socket2.binaryType = 'blob';
        socket2.onopen = function(msg) {
          $('#start').addClass('disabled');
          $('#stop').removeClass('disabled');
          $('#restart').removeClass('disabled');
          $('.server-status').show();
          $('.game-questions').show();
          return $('#status a').removeClass("btn-danger").addClass('btn-success').html('connected');
        };
        socket2.onmessage = function(msg) {
          //console.log(msg)
          var response;
          response = JSON.parse(msg.data);
          log2("Action: " + response.action + " - Data: " + response.data);
          switch (response.action) {
            case "statusMsg":
              return statusMsg(response.data);
            case "clientConnected":
              return clientConnected(response.data);
            case "clientDisconnected":
              return clientDisconnected(response.data);
            case "clientActivity":
              return clientActivity(response.data);
            case "serverInfo":
              return refreshServerinfo(response.data);
            case "rankingInfo":
              return rankingInfo(response.data);
          }
        };
        socket2.onclose = function(msg) {
          $('#start').removeClass('disabled');
          $('#stop').addClass('disabled');
          $('#restart').addClass('disabled');
          $('.server-status').hide();
          $('.game-questions').hide();
          return $('#status a').removeClass("btn-success").addClass('btn-danger').html('disconnected');
        };

        $('#data').bind('keypress', function(e) {
          var code = (e.keyCode ? e.keyCode : e.which);
          if(code == 13 && this.value) {
            send();
          }
        });
      
        $('#new-content-btn').click(function() {
          if($(this).hasClass("disabled")) return false;
          $(this).addClass("disabled");
          $('#new-content').show();
          $('#title').hide();
          $('#new-content-tag').focus();
        });

        $('#new-content-cancel').click(function() {
          if($(this).hasClass("disabled")) return false;
          $("#new-content-type:selected").removeAttr("selected");
          $('#new-content-tag').val("");
          $('#new-content-tag').show();
          $('#new-content-btn').removeClass("disabled")
          $('#new-content').hide();
        });

        saveContent = function(){
          //console.log(editor.getData());

          if($('#new-content-mode').val() == "create"){

            var tag = $('#new-content-tag-c').val();
            $.ajax({
              //url: "/ajax/fetch.php",
              url: "/ajax/fetch",
              data: "save=1&html="+editor.getData(),
              type: "POST",
              dataType: "text",
              async: false,
              success: function(url){
                if(url != ""){
                  var payload = new Object();
                  payload.action = "addcontent";
                  var data = new Object();
                  data.type = $('#new-content-type option:selected').val();
                  data.tag = tag;
                  data.source = $('#new-content-source').val();
                  data.id = $('#new-content-id').val();
                  //data.html = $('#preview').html();
                  data.url = url;
                  payload.data = data;
                  $("#new-content-type:selected").removeAttr("selected");
                  $('#new-content-tag').val("");
                  $('#new-content-source').val("")
                  $('#new-content-id').val("");
                  $('#new-content-btn').removeClass("disabled")
                  $('#preview').html("");
                  $('#new-content').hide();
                  //console.log(payload);
                  return socket2.send(JSON.stringify(payload));
                }
              }
            });

          }else if($('#new-content-mode').val() == "search"){
            if($('#preview').html()!=""){
              editor.setData($('#preview').html());
              var tag = $('#new-content-title').val();
              //save to cache
              $.ajax({
                url: "/ajax/fetch",
                //url: "/ajax/fetch.php",
                data: {
                  save: 1,
                  source: $('#new-content-source').val(),
                  html: editor.getData()
                },
                type: "POST",
                dataType: "text",
                async: false,
                success: function(url){
                  if(url != ""){
                    var payload = new Object();
                    payload.action = "addcontent";
                    var data = new Object();
                    data.type = $('#new-content-type option:selected').val();
                    data.tag = tag;
                    data.source = $('#new-content-source').val();
                    data.id = $('#new-content-id').val();
                    data.url = url;
                    payload.data = data;
                    $("#new-content-type:selected").removeAttr("selected");
                    $('#new-content-tag').val("");
                    $('#new-content-source').val("")
                    $('#new-content-id').val("");
                    $('#new-content-btn').removeClass("disabled")
                    $('#preview').html("");
                    $('#new-content').hide();
                    //console.log(payload);
                    return socket2.send(JSON.stringify(payload));
                  }
                }
              });
              
            }
          }
        }

        $(".sendcontent").live('click', function(){
          if($(this).hasClass("disabled")) return false;
          var payload = new Object();
          payload.action = "sendcontent";
          payload.data = $(this).attr('rel');
          $(this).addClass("disabled");
          $(this).prev().show();
          return socket2.send(JSON.stringify(payload));
        });

        $(".removecontent").live('click', function(){
          if($(this).hasClass("disabled")) return false;
          var payload = new Object();
          payload.action = "removecontent";
          payload.data = $(this).attr('rel');
          $(this).addClass("disabled");
          return socket2.send(JSON.stringify(payload));
        });

        $(".bancontent").live('click', function(){
          if($(this).hasClass("disabled")) return false;
          var payload = new Object();
          payload.action = "bancontent";
          payload.data = $(this).attr('rel');
          $(this).addClass("disabled");
          return socket2.send(JSON.stringify(payload));
        });

        $('#admin').click(function() {
          if($(this).hasClass("disabled")) return false;
          var payload = new Object();
          payload.action = "admin";
          payload.data = 1;
          //$('#admin').addClass('disabled');
          return socket2.send(JSON.stringify(payload));
        });

        log = function(msg) {
          return $('#log').prepend("" + msg + "<br />");
        };
        statusMsg = function(msgData) {
          switch (msgData.type) {
            case "info":
              return log(msgData.text);
            case "warning":
              return log("<span class=\"warning\">" + msgData.text + "</span>");
          }
        };
        clientConnected = function(data) {
          $('#clientListSelect').append(new Option("" + data.ip + ":" + data.port, data.port));
          return $('#clientCount').text(data.clientCount);
        };
        clientDisconnected = function(data) {
          $("#clientListSelect option[value='" + data.port + "']").remove();
          return $('#clientCount').text(data.clientCount);
        };

        refreshServerinfo = function(serverinfo) {
          //console.log(serverinfo)
          var name, email, points, _ref, _results;
          $('#host').text(serverinfo.host);
          $('#port').text(serverinfo.port);
          $('#check').text(serverinfo.check);
          $('#clientCount').text(serverinfo.clientCount);
          $('#maxClients').text(serverinfo.maxClients);
          $('#maxConnections').text(serverinfo.maxConnectionsPerIp);
          $('#maxRequetsPerMinute').text(serverinfo.maxRequetsPerMinute);

          _ref = serverinfo.clients;
          var c = 0;
          $('#clientTableBody').html('');
          for (port in _ref) {
            c++;
            ip = _ref[port][0];
            name = _ref[port][1];
            email = _ref[port][2];
            //var btns = '<div class="btn-group"><a class="btn btn-danger btn-mini message-user" href="#"><i class="icon-comment icon-white"></i> Message</a>';
            //btns += '<a class="btn btn-danger btn-mini kick-user" href="#"><i class="icon-remove icon-white"></i> Kick</a></div>';
            //$('#clientTableBody').append('<tr><td>'+ip+'</td><td>'+port+'</td><td>'+name+'</td><td>'+email+'</td><td>'+btns+'</td></tr>');
            $('#clientTableBody').append('<tr><td>'+port+'</td></tr>');
            
          }
          $('#nun_clients').html(c);
          
          $('#content-list').html("");
          //for(var j=serverinfo.contents.length-1; j>=0; j--){
          for(var j=0; j<serverinfo.contents.length; j++){
            if(serverinfo.contents[j]){
              var dis2 = ' disabled';
              var dis = ' disabled';
              var vis = ' inline-block';
              //console.log(serverinfo.contents[j])
              if(!serverinfo.contents[j].sent){
                dis = '';
                vis = ' none';
              }
              if(!serverinfo.contents[j].banned)
                dis2 = '';
              var html = '<tr><td>'+serverinfo.contents[j].id+'</td>';
              html += '<td>'+serverinfo.contents[j].source+'</td>';
              html += '<td>'+serverinfo.contents[j].type+'</td>';
              html += '<td>'+serverinfo.contents[j].tag+'</td>';
              html += '<td><a class="btn btn-mini btn-danger removecontent" style="margin-right: 5px;" rel="'+j+'"><i class="icon-remove icon-white"></i> Delete</a>';
              //html += '<a class="btn btn-mini btn-warning pull-right editcontent" style="margin-left: 5px;" rel="'+j+'"><i class="icon-edit icon-white"></i> Edit</a>';
              html += '<a class="btn btn-mini btn-danger bancontent'+dis2+'" style="margin-right: 5px; display: '+vis+';" rel="'+j+'"><i class="icon-ban-circle icon-white"></i> Ban</a>';
              html += '<a class="btn btn-mini btn-success sendcontent'+dis+'" rel="'+j+'"><i class="icon-play icon-white"></i> Send</a></td></tr>';

              //html += '<ul><li>'+serverinfo.contents[j].tag+'</li>';
              //html += '<li>type: '+serverinfo.contents[j].type+'</li>';
              //html += '<li>source: '+serverinfo.contents[j].source+'</li>';
              //html += '<li>id: '+serverinfo.contents[j].id+'</li>';
              //html += '</ul><hr />';

              $('#content-list').append(html);
            }
          }
          return;
        };
        return clientActivity = function(port) {
          return $("#clientListSelect option[value='" + port + "']").css("color", "red").animate({
            opacity: 100
          }, 600, function() {
            return $(this).css("color", "black");
          });
        };
      }
      
      $(document).ready(function() {

        $('#form-tab a').click(function(e) {
          e.preventDefault();
          $('#preview').html('');
          $('#new-content-html-c').val("");
          $(this).tab('show');
          if($(this).attr('href') == "#search"){
            $('#new-content-mode').val("search");
            $('#new-content-tag').val("");
            $('#preview').html("");
            $('#new-content-save').show();
            $('#new-content-save').addClass('disabled');
            $('#new-content-edit').hide();
            $('#preview-w').hide();
            $('#cke_new-content-html-c').hide();
            $('#new-content-tag-c').hide();
            $('#new-content-preview').hide();
            $('#new-content-save').show();
            $('#new-content-tag').focus();
          }else{
            $('#new-content-mode').val("create");
            $('#new-content-tag-c').val("");
            editor.setData("");
            $('#preview').html("");
            $('#cke_new-content-html-c').show();
            $('#new-content-tag-c').show();
            $('#preview-w').hide();
            $('#new-content-preview').show();
            $('#new-content-save').hide();
            $('#new-content-tag-c').focus();
          }
        });

        $('#new-content-tag-c').bind('keypress', function(e) {
          if($('#new-content-tag-c').val() != "")
            $('#new-content-preview').removeClass('disabled');
          else
            $('#new-content-preview').addClass('disabled');
        });

        $('#new-content-tag').autocomplete({
          serviceUrl: '/ajax/search',
          //serviceUrl: '/ajax/fetch.php',
          onSelect: function (suggestion) {
            self.location.hash = "#preview-a";
            $('#new-content-save').show();
            $('#new-content-preview').hide();
            var tag = $('#new-content-tag').val();
            tag = tag.replace('Astolfo: ', '');
            tag = tag.replace('Wikipedia: ', '');
            $('#new-content-tag').val(tag);
            $('#new-content-tag').hide();
            $('#new-content-title').val(tag);

            $('#new-content-save').addClass('disabled');
            $('#fetching').show();

            $('#new-content-source').val(suggestion.data.source);
            $('#new-content-id').val(suggestion.data.id);
            if(suggestion.data.source == "Astolfo"){
              //$('#preview').load("/ajax/fetch.php?source="+suggestion.data.source+"&id="+suggestion.data.id, function(){
              $('#preview').load("/ajax/fetch?source="+suggestion.data.source+"&id="+suggestion.data.id, function(){
                $('#new-content-save').removeClass('disabled');
                $('#fetching').hide();
                $('#title').show();
                $('#preview-w').show();
              });
            }else{
              //$('#preview').load("/ajax/fetch.php?source="+suggestion.data.source+"&id="+suggestion.data.id, function(){
              $('#preview').load("/ajax/fetch?source="+suggestion.data.source+"&id="+suggestion.data.id, function(){
                $('#new-content-save').removeClass('disabled');
                $('#fetching').hide();
                $('#title').show();
                $('#preview-w').show();
              });
            }
          }
        });
        
        $('#start').click(function() {
          if($(this).hasClass("disabled")) return false;
          self.location.href='admin.php?start';
        });
        $('#stop').click(function() {
          if($(this).hasClass("disabled")) return false;
          self.location.href='admin.php?stop';
        });
        $('#restart').click(function() {
          if($(this).hasClass("disabled")) return false;
          self.location.href='admin.php?restart';
        });

        $('#new-content-tag').bind('keypress', function(e) {
          var code = (e.keyCode ? e.keyCode : e.which);
          if(code == 13 && this.value) {
            saveContent();
            return false;
          }
        });

        initClient();
      });

      window.onload=function(){
        window.onbeforeunload = function(){
          return "NÃO FECHE ESTA JANELA!!!!!!!";
        }
      }
      </script>

      <!-- CKEDITOR -->
      <script src="ckeditor/ckeditor.js"></script>
      <script type="text/javascript">
      var editor = CKEDITOR.replace( 'new-content-html-c', {
        toolbar: [
          { name: 'document', groups: [ 'mode', 'document', 'doctools' ], items: [ 'Source' ] },
          { name: 'clipboard', groups: [ 'clipboard', 'undo' ], items: [ 'Cut', 'Copy', 'Paste', 'PasteText', 'PasteFromWord', '-', 'Undo', 'Redo' ] },
          { name: 'editing', groups: [ 'find', 'selection', 'spellchecker' ], items: [ 'Scayt' ] },
          '/',
          { name: 'basicstyles', groups: [ 'basicstyles', 'cleanup' ], items: [ 'Bold', 'Italic', 'Strike', '-', 'RemoveFormat' ] },
          { name: 'paragraph', groups: [ 'list', 'indent', 'blocks', 'align' ], items: [ 'NumberedList', 'BulletedList', '-', 'Outdent', 'Indent', '-', 'Blockquote' ] },
          { name: 'links', items: [ 'Link', 'Unlink', 'Anchor' ] },
          { name: 'insert', items: [ 'Image', 'Table', 'HorizontalRule', 'SpecialChar' ] },
          '/',
          { name: 'styles', items: [ 'Styles', 'Format' ] },
          { name: 'tools', items: [ 'Maximize' ] }
        ]
      });

      $('#new-content-preview').click(function() {
        if($(this).hasClass("disabled")) return false;
        if(editor.getData()!=""){
          $('#preview').html( editor.getData() );
          $('#preview-w').show();
          $('#new-content-tag-c').hide();
          $('#new-content-preview').hide();
          $('#new-content-edit').show();
          $('#new-content-save').removeClass('disabled').show();
          $('#cke_new-content-html-c').hide();
        }
      });

      $('#new-content-edit').click(function() {
        $('#preview').html("");
        $('#preview-w').hide();
        $('#new-content-tag-c').show();
        $('#new-content-preview').show();
        $('#new-content-edit').hide();
        $('#new-content-save').addClass('disabled').hide();
        $('#cke_new-content-html-c').show();
      });

      $('#new-content-save').click(function() {
        if($(this).hasClass("disabled")) return false;
        $('#preview-w').hide();
        $('#new-content-tag-c').show();
        $('#new-content-tag').show();
        $('#new-content-preview').show();
        $('#new-content-edit').hide();
        $('#new-content-save').addClass('disabled').hide();
        $('#cke_new-content-html-c').show();
        saveContent();
      });

      </script>

      <hr />

      <footer>
        <p>&copy; 2012 cmais+ O portal de conteúdo da Cultura</p>
      </footer>

      </div>
  </div>
  
</body>
</html>