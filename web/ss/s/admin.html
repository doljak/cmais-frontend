<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8">
    <title>Jornal da Cultura · Segunda Tela</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="../docs/assets/css/bootstrap.css" rel="stylesheet">
    <link href="../docs/assets/css/bootstrap-responsive.css" rel="stylesheet">
    <link href="../docs/assets/css/docs.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../docs/assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../docs/assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../docs/assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../docs/assets/ico/apple-touch-icon-57-precomposed.png">
    <link rel="shortcut icon" href="../img/favicon.png">

    <style type="text/css">
      #preview { 
        margin-top: 13px;
      }
      #preview img {
        width: 40%;
        float: left;
        margin-right: 13px;
      }
      #new-content-tag{
        padding-right: 35px;
        /* background-image: url('../img/loading6.gif'); */
        background-repeat: no-repeat;
        background-position: right;
      }
      .ui-autocomplete-loading { background: white url('../img/loading6.gif') right center no-repeat; }
      .loading { background: white url('../img/loading6.gif') right center no-repeat; }
      .autocomplete-suggestions { border: 1px solid #999; background: #FFF; cursor: default; overflow: auto; }
      .autocomplete-suggestion { padding: 2px 5px; white-space: nowrap; overflow: hidden; }
      .autocomplete-selected { background: #F0F0F0; }
      .autocomplete-suggestions strong { font-weight: normal; color: #3399FF; }
    </style>
  </head>

  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/backend.php/" style="float: left; margin-top: 5px;">Jornal da Cultura · Segunda Tela</a>

          <div id="status" class="pull-right" style="margin-left: 5px; margin-top: 5px">
            <a class="btn btn-danger disabled">
              Offline
            </a>
          </div>

          <div class="btn-toolbar pull-right" style="margin-right: 15px;">
            <div class="btn-group">
              <a id="admin" class="btn btn-warning btn-mini"><i class="icon-refresh icon-white"></i> Refresh</a>
            </div>
            <div class="btn-group">
              <a id="restart" class="btn btn-primary btn-mini"><i class="icon-refresh icon-white"></i> Restart</a>
              <a id="stop" class="btn btn-primary btn-mini"><i class="icon-stop icon-white"></i> Stop</a>
              <a id="start" class="btn btn-primary btn-mini"><i class="icon-play icon-white"></i> Start</a>
            </div>
          </div>

        </div>

      </div><!-- /navbar-inner -->
      
    </div>
    
    
    <div class="container-fluid">
      
      <div class="row-fluid server-status hide">
        
        <div class="span3">
          <div class="page-header">
            <h2>Server Info <!--<small> Características do servidor</small>--></h2>
          </div>
          <div id="serverInfo" class="pull-left2">
            <p>Host: <span id="host">astolfo</span></p>
            <p>Port: <span id="port">9999</span></p>
            <p>Check origin: <span id="check">No</span></p>
            <p>Connected Clients: <span id="clientCount"></span></p>
            <p>Limit Clients: <span id="maxClients"></span></p>
            <p>Limit Connections/IP: <span id="maxConnections"></span></p>
            <p>Limit Requetes/Min: <span id="maxRequetsPerMinute"></span></p>
          </div>
        </div>
        
        <div class="span4">
          <div class="page-header">
            <h2>Clients <small id="nun_clients"></small></h2>
          </div>
          <table class="table table-striped table-hover" id="clientTable" style="height: 230px; overflow: auto; display: block;">
            <thead>
              <tr>
                <th>ID</th>
                <!-- <th>Actions</th> -->
              </tr>
            </thead>
            <tbody id="clientTableBody"></tbody>
          </table>
        </div>
        
        
        <div class="span5">
          <div class="page-header">
            <h2>Messages <!--<small>Mensagens trafegando pelo server</small>  <span id="status2" class="offline" style="display: none; font-size: 20px; line-height: 35px;">disconnected</span>--></h2>
          </div>
          <div id="log2" style="margin: 6px 0 10px 0; padding: 5px; border: 1px solid red; height: 215px; overflow: auto; -webkit-border-radius: 3px; -moz-border-radius: 3px; border-radius: 3px;"></div>
          <!--    
          <form class="form-inline">
            <input type="text" id="title" class="input-small" placeholder="Title" />
            <input type="text" id="description" class="input-medium" placeholder="Description" />
            <input type="text" id="url" class="input-large" placeholder="URL" />
            <button id="send" type="button" class="btn btn-inverse">Send</button>
          </form>
          -->

        </div>
                    

      </div>

      <div class="row-fluid contents">
        <div class="span12">
          <div class="page-header">
            <h2>Content <!--<small>Mensagens trafegando pelo server</small>  <span id="status2" class="offline" style="display: none; font-size: 20px; line-height: 35px;">disconnected</span>--></h2>
          </div>
          <div style="display: block;">
            <a id="new-content-btn" class="btn btn-mini btn-primary"><i class="icon-plus icon-white"></i> Add New Content</a>
            <div id="new-content" class="hide" style="display: none; margin-bottom: 100px;">
              <div class="page-header">
                <h4>New Content</h4>
              </div>
              <form class="form-inline" onsubmit="return false">
                <div class="controls">
                  <input type="hidden" id="new-content-source" value="" />
                  <input type="hidden" id="new-content-id" value="" />
                  <select id="new-content-type" class="input-medium">
                    <option value="content">Conteúdo</option>
                    <option value="people">Pessoa</option>
                    <option value="place">Lugar</option>
                    <option value="poll">Enquete</option>
                  </select>
                  <input type="text" id="new-content-tag" class="input-xlarge typeahead" placeholder="tag or slug" autocomplete="off" />
                </div>
              </form>
              <div class="controls" style="clear: both;">
                <a id="new-content-save" class="btn btn-mini btn-success disabled"><i class="icon-ok icon-white"></i> Save</a>
                <a id="new-content-cancel" class="btn btn-mini btn-danger"><i class="icon-remove icon-white"></i> Cancel</a>
              </div>
              <div id="preview"></div>
              <hr />
            </div>
            <div id="content-list" style="margin-top: 25px;"></div>
          </div>

        </div>
      </div>
      
      <script src="../docs/assets/js/jquery.js"></script>
      <script src="../docs/assets/js/bootstrap-typeahead.js"></script>
      <script src="../js/jquery.autocomplete.js"></script>
      <script src="../js/json2.js"></script>

      <!-- CLIENT -->
      <script>
      function initClient(){
        var log2, serverUrl2, socket2;
        log2 = function(msg) {
          //$('#log2').append("" + msg + "<br />");
          $log2 = $('#log2');
          //Add text to log2
          $log2.append(($log2.val()?"<br />":'<br />')+msg);
          //Autoscroll
          $log2[0].scrollTop = $log2[0].scrollHeight - $log2[0].clientHeight;
          return true;
        };
        
        //serverUrl2 = 'ws://172.20.1.79:4443/quiz';
        //serverUrl2 = 'ws://200.136.27.32:443/quiz';
        //serverUrl2 = 'ws://172.20.18.133:4443/secondscreen';
        //serverUrl2 = 'ws://200.136.27.32:4443/secondscreen';
        //serverUrl2 = 'ws://200.136.27.32:443/secondscreen';
        serverUrl2 = 'ws://200.136.27.32:443/secondscreen';
        if (window.MozWebSocket) {
          socket2 = new MozWebSocket(serverUrl2);
        } else if (window.WebSocket) {
          socket2 = new WebSocket(serverUrl2);
        }
        
        socket2.binaryType = 'blob';
        socket2.onopen = function(msg) {
          $('#start').addClass('disabled');
          $('#stop').removeClass('disabled');
          $('#restart').removeClass('disabled');
          $('.server-status').show();
          $('.game-questions').show();
          return $('#status a').removeClass("btn-danger").addClass('btn-success').html('connected');
        };
        socket2.onmessage = function(msg) {
          //console.log(msg)
          var response;
          response = JSON.parse(msg.data);
          log2("Action: " + response.action + " - Data: " + response.data);
          switch (response.action) {
            case "statusMsg":
              return statusMsg(response.data);
            case "clientConnected":
              return clientConnected(response.data);
            case "clientDisconnected":
              return clientDisconnected(response.data);
            case "clientActivity":
              return clientActivity(response.data);
            case "serverInfo":
              return refreshServerinfo(response.data);
            case "rankingInfo":
              return rankingInfo(response.data);
          }
        };
        socket2.onclose = function(msg) {
          $('#start').removeClass('disabled');
          $('#stop').addClass('disabled');
          $('#restart').addClass('disabled');
          $('.server-status').hide();
          $('.game-questions').hide();
          return $('#status a').removeClass("btn-success").addClass('btn-danger').html('disconnected');
        };

        function send(){
          var payload = new Object();
          payload.action = "echo";
          payload.title = $('#title').val();
          payload.description = $('#description').val();
          payload.url = $('#url').val();
          payload.data = $('#title').val()+" | "+$('#description').val()+" | "+$('#url').val()/*+" | "+$('#duration').val()*/;
          return socket2.send(JSON.stringify(payload));
        }

        function startgame(){
          var payload = new Object();
          payload.action = "start";
          payload.data = 1;
          $('#start-game').addClass('disabled');
          $('#stop-game').removeClass('disabled');
          return socket2.send(JSON.stringify(payload));
        }

        function stopgame(){
          var payload = new Object();
          payload.action = "stop";
          payload.data = 1;
          $('#stop-game').addClass('disabled');
          $('#start-game').removeClass('disabled');
          return socket2.send(JSON.stringify(payload));
        }

        $('#data').bind('keypress', function(e) {
          var code = (e.keyCode ? e.keyCode : e.which);
          if(code == 13 && this.value) {
            send();
          }
        });
      
        $('#send').click(function() {
          send();
        });

        $('#new-content-btn').click(function() {
          if($(this).hasClass("disabled")) return false;
          $(this).addClass("disabled");
          $('#new-content').show();
          $('#new-content-tag').focus();
        });

        $('#new-content-cancel').click(function() {
          if($(this).hasClass("disabled")) return false;
          $("#new-content-type:selected").removeAttr("selected");
          $('#new-content-tag').val("");
          $('#new-content-btn').removeClass("disabled")
          $('#new-content').hide();
        });

        saveContent = function(){
          if($('#preview').html()!=""){
            //save to cache
            $.ajax({
              //$('#preview').load("fetch.php?source="+suggestion.data.source+"&id="+suggestion.data.id);
              //url: "fetch.php",
              url: "/ajax/fetch",
              data: "save=1&source="+$('#new-content-source').val()+"&id="+$('#new-content-id').val(),
              dataType: "text",
              async: false,
              success: function(url){
                if(url != ""){
                  var payload = new Object();
                  payload.action = "addcontent";
                  var data = new Object();
                  data.type = $('#new-content-type option:selected').val();
                  data.tag = $('#new-content-tag').val();
                  data.source = $('#new-content-source').val();
                  data.id = $('#new-content-id').val();
                  //data.html = $('#preview').html();
                  data.url = url;
                  payload.data = data;
                  $("#new-content-type:selected").removeAttr("selected");
                  $('#new-content-tag').val("");
                  $('#new-content-source').val("")
                  $('#new-content-id').val("");
                  $('#new-content-btn').removeClass("disabled")
                  $('#preview').html("");
                  $('#new-content').hide();
                  //console.log(payload);
                  return socket2.send(JSON.stringify(payload));
                }
              }
            });
          }
        }

        $('#new-content-save').click(function() {
          if($(this).hasClass("disabled")) return false;
          saveContent();
        });

        $(".sendcontent").live('click', function(){
          if($(this).hasClass("disabled")) return false;
          var payload = new Object();
          payload.action = "sendcontent";
          payload.data = $(this).attr('rel');
          $(this).addClass("disabled");
          return socket2.send(JSON.stringify(payload));
        });

        $(".removecontent").live('click', function(){
          if($(this).hasClass("disabled")) return false;
          var payload = new Object();
          payload.action = "removecontent";
          payload.data = $(this).attr('rel');
          $(this).addClass("disabled");
          return socket2.send(JSON.stringify(payload));
        });

        $('#admin').click(function() {
          if($(this).hasClass("disabled")) return false;
          var payload = new Object();
          payload.action = "admin";
          payload.data = 1;
          //$('#admin').addClass('disabled');
          return socket2.send(JSON.stringify(payload));
        });

        log = function(msg) {
          return $('#log').prepend("" + msg + "<br />");
        };
        statusMsg = function(msgData) {
          switch (msgData.type) {
            case "info":
              return log(msgData.text);
            case "warning":
              return log("<span class=\"warning\">" + msgData.text + "</span>");
          }
        };
        clientConnected = function(data) {
          $('#clientListSelect').append(new Option("" + data.ip + ":" + data.port, data.port));
          return $('#clientCount').text(data.clientCount);
        };
        clientDisconnected = function(data) {
          $("#clientListSelect option[value='" + data.port + "']").remove();
          return $('#clientCount').text(data.clientCount);
        };

        refreshServerinfo = function(serverinfo) {
          //console.log(serverinfo)
          var name, email, points, _ref, _results;
          $('#host').text(serverinfo.host);
          $('#port').text(serverinfo.port);
          $('#check').text(serverinfo.check);
          $('#clientCount').text(serverinfo.clientCount);
          $('#maxClients').text(serverinfo.maxClients);
          $('#maxConnections').text(serverinfo.maxConnectionsPerIp);
          $('#maxRequetsPerMinute').text(serverinfo.maxRequetsPerMinute);

          _ref = serverinfo.clients;
          var c = 0;
          $('#clientTableBody').html('');
          for (port in _ref) {
            c++;
            ip = _ref[port][0];
            name = _ref[port][1];
            email = _ref[port][2];
            //var btns = '<div class="btn-group"><a class="btn btn-danger btn-mini message-user" href="#"><i class="icon-comment icon-white"></i> Message</a>';
            //btns += '<a class="btn btn-danger btn-mini kick-user" href="#"><i class="icon-remove icon-white"></i> Kick</a></div>';
            //$('#clientTableBody').append('<tr><td>'+ip+'</td><td>'+port+'</td><td>'+name+'</td><td>'+email+'</td><td>'+btns+'</td></tr>');
            $('#clientTableBody').append('<tr><td>'+port+'</td></tr>');
            
          }
          $('#nun_clients').html(c);
          
          $('#content-list').html("");
          //for(var j=serverinfo.contents.length-1; j>=0; j--){
          for(var j=0; j<serverinfo.contents.length; j++){
            if(serverinfo.contents[j]){
              var dis = ' disabled';
              //console.log(serverinfo.contents[j])
              if(!serverinfo.contents[j].sent)
                dis = '';
              var html = '<a class="btn btn-mini btn-danger pull-right removecontent" style="margin-left: 5px;" rel="'+j+'"><i class="icon-remove icon-white"></i> Delete</a>';
              //html += '<a class="btn btn-mini btn-warning pull-right editcontent" style="margin-left: 5px;" rel="'+j+'"><i class="icon-edit icon-white"></i> Edit</a>';
              html += '<a class="btn btn-mini btn-success pull-right sendcontent'+dis+'" rel="'+j+'"><i class="icon-play icon-white"></i> Send</a>';
              html += '<ul><li>'+serverinfo.contents[j].tag+'</li>';
              html += '<li>type: '+serverinfo.contents[j].type+'</li>';
              html += '<li>source: '+serverinfo.contents[j].source+'</li>';
              html += '<li>id: '+serverinfo.contents[j].id+'</li>';
              html += '</ul><hr />';
              $('#content-list').append(html);
            }
          }          
          return;
        };
        return clientActivity = function(port) {
          return $("#clientListSelect option[value='" + port + "']").css("color", "red").animate({
            opacity: 100
          }, 600, function() {
            return $(this).css("color", "black");
          });
        };
      }
      
      $(document).ready(function() {

        $('#new-content-tag').autocomplete({
          //serviceUrl: '/ss/server/search.php',
          serviceUrl: '/ajax/search',
          search  : function(){ $('.typeahead').addClass('loading'); console.log(1); },
          open    : function(){ $('.typeahead').removeClass('loading'); console.log(2); },
          onSelect: function (suggestion) {
            $('#new-content-save').addClass('disabled');
            //alert('You selected: ' + suggestion.value + ', ' + suggestion.data);
            $('#new-content-source').val(suggestion.data.source);
            $('#new-content-id').val(suggestion.data.id);
            if(suggestion.data.source == "Astolfo"){
              //$('#preview').load("/ajax/preview?id="+suggestion.data.id, function(){
              $('#preview').load("/ajax/fetch?source="+suggestion.data.source+"&id="+suggestion.data.id, function(){
                $('#new-content-save').removeClass('disabled');
              });
            }else{
              //$('#preview').load("fetch.php?source="+suggestion.data.source+"&id="+suggestion.data.id, function(){
              $('#preview').load("/ajax/fetch?source="+suggestion.data.source+"&id="+suggestion.data.id, function(){
                $('#new-content-save').removeClass('disabled');
              });
            }
            /*
            $.ajax({
              url: "fetch.php",
              data: "source="+suggestion.data.source+"&id="+suggestion.data.id,
              dataType: "json",
              async: false,
              success: function(data){
                $('#preview').html(data.html);
              }
            });
            */
          }
        });
        /*
        $('.typeahead').typeahead({
          source: function (typeahead, query) {
            //console.log(query.length);
            var return_list = [];
            //if(query.length > 7){
              $.ajax({
                url: "search.php",
                data: "query="+typeahead.query,
                dataType: "json",
                async: false,
                success: function(data){
                  $.each(data, function(i, data){
                    return_list.push(data);
                  });
                }
              });
            //}
            // here I'm just returning a list of strings
            return return_list
          },
          // typeahead calls this function when a object is selected, and
          // passes an object or string depending on what you processed, in this case a string
          onselect: function (obj) {
            //console.log(obj)
            $('#new-content-source').val(obj.source);
            $('#new-content-id').val(obj.id);
            $.ajax({
              url: "fetch.php",
              data: "source="+obj.source+"&id="+obj.id,
              dataType: "json",
              async: false,
              success: function(data){
                $('#preview').html(data.html);
              }
            });
          }
        });
        */
       
        $('#start').click(function() {
          if($(this).hasClass("disabled")) return false;
          self.location.href='admin.php?start';
        });
        $('#stop').click(function() {
          if($(this).hasClass("disabled")) return false;
          self.location.href='admin.php?stop';
        });
        $('#restart').click(function() {
          if($(this).hasClass("disabled")) return false;
          self.location.href='admin.php?restart';
        });

        $('#new-content-tag').bind('keypress', function(e) {
          var code = (e.keyCode ? e.keyCode : e.which);
          if(code == 13 && this.value) {
            saveContent();
            return false;
          }
        });

        initClient();
      });
      </script>

      <hr />

      <footer>
        <p>&copy; 2012 cmais+ O portal de conteúdo da Cultura</p>
      </footer>

      </div>
  </div>
  
</body>
</html>