<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8">
    <title>Godofredo · Segunda Tela Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="../docs/assets/css/bootstrap.css" rel="stylesheet">
    <link href="../docs/assets/css/bootstrap-responsive.css" rel="stylesheet">

    <link href="../docs/assets/css/docs.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="../img/favicon.png">

    <style type="text/css">
      #new-content-tag{
        padding-right: 35px;
        /* background-image: url('../img/loading6.gif'); */
        background-repeat: no-repeat;
        background-position: right;
      }
      .ui-autocomplete-loading { background: white url('../img/loading6.gif') right center no-repeat; }
      .loading { background: white url('../img/loading6.gif') right center no-repeat; }
      .autocomplete-suggestions { border: 1px solid #999; background: #FFF; cursor: default; overflow: auto; }
      .autocomplete-suggestion { padding: 2px 5px; white-space: nowrap; overflow: hidden; }
      .autocomplete-selected { background: #F0F0F0; }
      .autocomplete-suggestions strong { font-weight: normal; color: #3399FF; }
    </style>
  </head>

  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a title="Godofredo"><img src="../img/godofredo.gif" alt="Godoferdo" style="float: left; height: 50px; padding: 3px 0px 3px 0px;" /></a>
          <a class="brand" title="Godofredo" style="float: left; margin-top: 5px;">
            Godofredo
          </a>

          <div id="status" class="pull-right" style="margin-left: 5px; margin-top: 5px">
            <a class="btn btn-danger disabled">
              Offline
            </a>
          </div>

          <div class="btn-toolbar pull-right" style="margin-right: 15px;">
            <div class="btn-group">
              <a id="admin" class="btn btn-primary btn-mini"><i class="icon-refresh icon-white"></i> Refresh</a>
            </div>
            <div class="btn-group">
              <a id="restart" class="btn btn-danger btn-mini disabled"><i class="icon-refresh icon-white"></i> Restart</a>
              <a id="stop" class="btn btn-danger btn-mini disabled"><i class="icon-stop icon-white"></i> Stop</a>
              <a id="start" class="btn btn-danger btn-mini disabled"><i class="icon-play icon-white"></i> Start</a>
            </div>
          </div>

        </div>

      </div><!-- /navbar-inner -->
      
    </div>
    
    
    <div class="container-fluid">
      
      <div class="row-fluid server-status hide">
        
        <div class="span3">
          <div class="page-header">
            <h4>Server Info</h4>
          </div>
          <div id="serverInfo" class="pull-left2">
            <p>Host: <span id="host">astolfo</span></p>
            <p>Port: <span id="port">9999</span></p>
            <p>Check origin: <span id="check">No</span></p>
            <p>Connected Clients: <span id="clientCount"></span></p>
            <p>Limit Clients: <span id="maxClients"></span></p>
            <p>Limit Connections/IP: <span id="maxConnections"></span></p>
            <p>Limit Requetes/Min: <span id="maxRequetsPerMinute"></span></p>
          </div>
        </div>
        
        <div class="span4">
          <div class="page-header">
            <h4>Clients <small id="nun_clients"></small></h4>
          </div>
          <table class="table table-striped table-hover" id="clientTable" style="height: 230px; overflow: auto; display: block;">
            <thead>
              <tr>
                <th>ID</th>
                <!-- <th>Actions</th> -->
              </tr>
            </thead>
            <tbody id="clientTableBody"></tbody>
          </table>
        </div>
        
        <div class="span5">
          <div class="page-header">
            <h4>Messages</h4>
          </div>
          <div id="log2" style="margin: 6px 0 10px 0; padding: 5px; border: 1px solid red; height: 215px; overflow: auto; -webkit-border-radius: 3px; -moz-border-radius: 3px; border-radius: 3px;"></div>
        </div>

      </div>

      <div class="row-fluid contents">
        <div class="span12">

          <div style="display: block;">
            <a id="new-content-btn" class="btn btn-mini btn-primary pull-right"><i class="icon-plus icon-white"></i> Add New Content</a>

            <div id="new-content" class="hide" style="display: none; margin-bottom: 100px; margin-top: 10px;">
              
              <div class="page-header">
                <h4>New Content</h4>
              </div>

              <form class="form-inline" onsubmit="return false">
                <input type="hidden" id="new-content-source" value="" />
                <input type="hidden" id="new-content-id" value="" />

                <div class="controls" style="margin-bottom: 10px;">
                  <select id="new-content-type" class="input-medium">
                    <option value="content">Conteúdo</option>
                    <option value="people">Pessoa</option>
                    <option value="place">Lugar</option>
                    <option value="poll">Enquete</option>
                  </select>
                  <input type="text" id="new-content-tag" class="input-xxlarge typeahead" placeholder="tag or slug" autocomplete="off" style="margin: :0px;" />
                  <!--<button id="search-content-btn" class="btn" type="button" style="margin: 2px -1px;">Search!</button>-->
                </div>

                <div class="controls">
                  <textarea id="new-content-html-c" class="ckeditor" style="width: 100%;"></textarea>                
                </div>
              </form>

              <hr />
              <div class="controls" style="clear: both;">
                <a id="new-content-save" class="btn btn-mini btn-success disabled"><i class="icon-ok icon-white"></i> Save</a>
                <a id="new-content-cancel" class="btn btn-mini btn-danger"><i class="icon-remove icon-white"></i> Cancel</a>
              </div>
              
            </div>

            <div class="page-header">
              <h4>Content List</h4>
            </div>

            <table class="table table-hover table-condensed">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Source</th>
                  <th>Type</th>
                  <th>Title</th>
                  <th style="min-width: 185px;">Actions</th>
                </tr>
              </thead>
              <tbody id="content-list"></tbody>
            </table>

            <!--<div id="content-list" style="margin-top: 25px;"></div>-->

          </div>

        </div>
      </div>
      
      <script src="../docs/assets/js/jquery.js"></script>
      
      <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css">
      <script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>
      
      <!--<script src="../docs/assets/js/bootstrap-tab.js"></script>-->
      <script src="../js/json2.js"></script>
      <!--<script src="../js/jquery.autocomplete.js"></script>-->
      
      <script src="ckeditor/ckeditor.js"></script>

      <!-- CLIENT -->
      <script>
      $(document).ready(function() {
      //function initClient(){
        var log2, serverUrl2, socket2, autoinput, editor;
        log2 = function(msg) {
          //$('#log2').append("" + msg + "<br />");
          $log2 = $('#log2');
          //Add text to log2
          $log2.append(($log2.val()?"<br />":'<br />')+msg);
          //Autoscroll
          $log2[0].scrollTop = $log2[0].scrollHeight - $log2[0].clientHeight;
          return true;
        };
        
        serverUrl2 = 'ws://200.136.27.32:80/secondscreen';
        //serverUrl2 = 'ws://ss:8080/secondscreen';
        if (window.MozWebSocket) {
          socket2 = new MozWebSocket(serverUrl2);
        } else if (window.WebSocket) {
          socket2 = new WebSocket(serverUrl2);
        }
        
        socket2.binaryType = 'blob';
        socket2.onopen = function(msg) {
          //$('#start').addClass('disabled');
          //$('#stop').removeClass('disabled');
          //$('#restart').removeClass('disabled');
          $('.server-status').show();
          $('.game-questions').show();
          return $('#status a').removeClass("btn-danger").addClass('btn-success').html('connected');
        };
        socket2.onmessage = function(msg) {
          //console.log(msg)
          var response;
          response = JSON.parse(msg.data);
          log2("Action: " + response.action + " - Data: " + response.data);
          switch (response.action) {
            case "statusMsg":
              return statusMsg(response.data);
            case "clientConnected":
              return clientConnected(response.data);
            case "clientDisconnected":
              return clientDisconnected(response.data);
            case "clientActivity":
              return clientActivity(response.data);
            case "serverInfo":
              return refreshServerinfo(response.data);
            case "rankingInfo":
              return rankingInfo(response.data);
          }
        };
        socket2.onclose = function(msg) {
          $('#start').removeClass('disabled');
          $('#stop').addClass('disabled');
          $('#restart').addClass('disabled');
          $('.server-status').hide();
          $('.game-questions').hide();
          return $('#status a').removeClass("btn-success").addClass('btn-danger').html('disconnected');
        };

        $('#data').bind('keypress', function(e) {
          var code = (e.keyCode ? e.keyCode : e.which);
          if(code == 13 && this.value) {
            send();
          }
        });

        $(".sendcontent").live('click', function(){
          if($(this).hasClass("disabled")) return false;
          var payload = new Object();
          payload.action = "sendcontent";
          payload.data = $(this).attr('rel');
          $(this).addClass("disabled");
          $(this).prev().show();
          return socket2.send(JSON.stringify(payload));
        });

        $(".removecontent").live('click', function(){
          if($(this).hasClass("disabled")) return false;
          var payload = new Object();
          payload.action = "removecontent";
          payload.data = $(this).attr('rel');
          $(this).addClass("disabled");
          return socket2.send(JSON.stringify(payload));
        });

        $(".bancontent").live('click', function(){
          if($(this).hasClass("disabled")) return false;
          var payload = new Object();
          payload.action = "bancontent";
          payload.data = $(this).attr('rel');
          $(this).addClass("disabled");
          return socket2.send(JSON.stringify(payload));
        });

        $('#admin').click(function() {
          if($(this).hasClass("disabled")) return false;
          var payload = new Object();
          payload.action = "admin";
          payload.data = 1;
          //$('#admin').addClass('disabled');
          return socket2.send(JSON.stringify(payload));
        });

        saveContent = function(){
          $.ajax({
            url: "/ajax/fetch",
            data: {
              save: 1,
              html: editor.getData()
            },
            type: "POST",
            dataType: "text",
            async: false,
            success: function(url){
              if(url != ""){
                var payload = new Object();
                payload.action = "addcontent";
                var data = new Object();
                data.type = $('#new-content-type option:selected').val();
                data.tag = $("#new-content-tag").val();
                data.source = $('#new-content-source').val();
                data.id = $('#new-content-id').val();
                data.url = url;
                payload.data = data;
                $("#new-content-type:selected").removeAttr("selected");
                $("#new-content-tag").val("");
                $('#new-content-source').val("")
                $('#new-content-id').val("");
                $('#new-content-btn').removeClass("disabled")
                $('#new-content').hide();
                editor.setData("");
                //console.log(payload);
                return socket2.send(JSON.stringify(payload));
              }
            }
          });
        }
        
        log = function(msg) {
          return $('#log').prepend("" + msg + "<br />");
        };
        statusMsg = function(msgData) {
          switch (msgData.type) {
            case "info":
              return log(msgData.text);
            case "warning":
              return log("<span class=\"warning\">" + msgData.text + "</span>");
          }
        };
        clientConnected = function(data) {
          $('#clientListSelect').append(new Option("" + data.ip + ":" + data.port, data.port));
          return $('#clientCount').text(data.clientCount);
        };
        clientDisconnected = function(data) {
          $("#clientListSelect option[value='" + data.port + "']").remove();
          return $('#clientCount').text(data.clientCount);
        };

        refreshServerinfo = function(serverinfo) {
          //console.log(serverinfo)
          var name, email, points, _ref, _results;
          $('#host').text(serverinfo.host);
          $('#port').text(serverinfo.port);
          $('#check').text(serverinfo.check);
          $('#clientCount').text(serverinfo.clientCount);
          $('#maxClients').text(serverinfo.maxClients);
          $('#maxConnections').text(serverinfo.maxConnectionsPerIp);
          $('#maxRequetsPerMinute').text(serverinfo.maxRequetsPerMinute);

          _ref = serverinfo.clients;
          var c = 0;
          $('#clientTableBody').html('');
          for (port in _ref) {
            c++;
            ip = _ref[port][0];
            name = _ref[port][1];
            email = _ref[port][2];
            //var btns = '<div class="btn-group"><a class="btn btn-danger btn-mini message-user" href="#"><i class="icon-comment icon-white"></i> Message</a>';
            //btns += '<a class="btn btn-danger btn-mini kick-user" href="#"><i class="icon-remove icon-white"></i> Kick</a></div>';
            //$('#clientTableBody').append('<tr><td>'+ip+'</td><td>'+port+'</td><td>'+name+'</td><td>'+email+'</td><td>'+btns+'</td></tr>');
            $('#clientTableBody').append('<tr><td>'+port+'</td></tr>');
            
          }
          $('#nun_clients').html(c);
          
          $('#content-list').html("");
          //for(var j=serverinfo.contents.length-1; j>=0; j--){
          if(serverinfo.contents){
            for(var j=0; j<serverinfo.contents.length; j++){
              if(serverinfo.contents[j]){
                var dis2 = ' disabled';
                var dis = ' disabled';
                var vis = ' inline-block';
                //console.log(serverinfo.contents[j])
                if(!serverinfo.contents[j].sent){
                  dis = '';
                  vis = ' none';
                }
                if(!serverinfo.contents[j].banned)
                  dis2 = '';
                var html = '<tr><td>'+serverinfo.contents[j].id+'</td>';
                html += '<td>'+serverinfo.contents[j].source+'</td>';
                html += '<td>'+serverinfo.contents[j].type+'</td>';
                html += '<td>'+serverinfo.contents[j].tag+'</td>';
                html += '<td><a class="btn btn-mini btn-danger removecontent" style="margin-right: 5px;" rel="'+j+'"><i class="icon-remove icon-white"></i> Delete</a>';
                //html += '<a class="btn btn-mini btn-warning editcontent" style="margin-left: 5px; display: '+vis+';" rel="'+j+'"><i class="icon-edit icon-white"></i> Edit</a>';
                html += '<a class="btn btn-mini btn-danger bancontent'+dis2+'" style="margin-right: 5px; display: '+vis+';" rel="'+j+'"><i class="icon-ban-circle icon-white"></i> Ban</a>';
                html += '<a class="btn btn-mini btn-success sendcontent'+dis+'" rel="'+j+'"><i class="icon-play icon-white"></i> Send</a></td></tr>';
  
                //html += '<ul><li>'+serverinfo.contents[j].tag+'</li>';
                //html += '<li>type: '+serverinfo.contents[j].type+'</li>';
                //html += '<li>source: '+serverinfo.contents[j].source+'</li>';
                //html += '<li>id: '+serverinfo.contents[j].id+'</li>';
                //html += '</ul><hr />';
  
                $('#content-list').append(html);
              }
            }
          }
          return;
        };
        
        clientActivity = function(port) {
          return $("#clientListSelect option[value='" + port + "']").css("color", "red").animate({
            opacity: 100
          }, 600, function() {
            return $(this).css("color", "black");
          });
        };
        
        //CKEDITOR
        editor = CKEDITOR.replace( 'new-content-html-c', {
          toolbar: [
            { name: 'document', items: ['Source', '-', 'Save', 'NewPage', 'Preview', 'Print', '-', 'Templates'] },
            { name: 'clipboard', items: ['Cut', 'Copy', 'Paste', 'PasteText', 'PasteFromWord', '-', 'Undo', 'Redo'] },
            { name: 'editing', items: ['Find', 'Replace', '-', 'SelectAll', '-', 'SpellChecker', 'Scayt'] },
            { name: 'forms', items: ['Form', 'Checkbox', 'Radio', 'TextField', 'Textarea', 'Select', 'Button', 'ImageButton',
                'HiddenField']
            },
            '/',
            { name: 'basicstyles', items: ['Bold', 'Italic', 'Underline', 'Strike', 'Subscript', 'Superscript', '-', 'RemoveFormat'] },
            { name: 'paragraph', items: ['NumberedList', 'BulletedList', '-', 'Outdent', 'Indent', '-', 'Blockquote', 'CreateDiv',
            '-', 'JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyBlock', '-', 'BidiLtr', 'BidiRtl']
            },
            { name: 'links', items: ['Link', 'Unlink', 'Anchor'] },
            { name: 'insert', items: ['Image', 'Flash', 'Table', 'HorizontalRule', 'Smiley', 'SpecialChar', 'PageBreak', 'Iframe'] },
            '/',
            { name: 'styles', items: ['Styles', 'Format', 'Font', 'FontSize'] },
            { name: 'colors', items: ['TextColor', 'BGColor'] },
            { name: 'tools', items: ['Maximize', 'ShowBlocks'] }
          ],
          height: 550,
        });

        $("#new-content-tag").autocomplete({
          source: function( request, response ) {
            $.ajax({
              //url: "http://cmais.com.br/ajax/search",
              url: "http://cmais.com.br/ajax/fetch",
              dataType: "jsonp",
              data: {
                query: request.term
              },
              success: function( data ) {
                console.log(data);
                if(data.suggestions!=null){
                  response( $.map( data.suggestions, function( item ) {
                    var tag = item.value;
                    tag = tag.replace('Astolfo: ', '');
                    tag = tag.replace('Wikipedia: ', '');
                    
                    return {
                      label: item.value,
                      value: tag,
                      data: item.data
                    }
                  }));
                }else{
                  $("#new-content-tag").removeClass('ui-autocomplete-loading');
                }
              }
            });
          },
          select: function( event, ui ) {
            console.log( ui.item ? "Selected: " + ui.item.label : "Nothing selected, input was " + this.value);
            editor.setData(null);
            $('#new-content-save').show();
            $('#new-content-save').addClass('disabled');
            $("#new-content-tag").addClass('ui-autocomplete-loading');
            $('#new-content-source').val(ui.item.data.source);
            $('#new-content-id').val(ui.item.data.id);
            $.ajax({
              url: "http://cmais.com.br/ajax/fetch",
              dataType: "jsonp",
              data: {
                source: ui.item.data.source,
                id: ui.item.data.id
              },
              success: function( data ) {
                editor.setData(data.html);
                $('#new-content-save').removeClass('disabled');
                $("#new-content-tag").removeClass('ui-autocomplete-loading');
              }
            });
          },
          open: function() {
            $( this ).removeClass( "ui-corner-all" ).addClass( "ui-corner-top" );
          },
          close: function() {
            $( this ).removeClass( "ui-corner-top" ).addClass( "ui-corner-all" );
          }
        });

        $('#start').click(function() {
          if($(this).hasClass("disabled")) return false;
          self.location.href='a.php?start';
        });
        $('#stop').click(function() {
          if($(this).hasClass("disabled")) return false;
          self.location.href='a.php?stop';
        });
        $('#restart').click(function() {
          if($(this).hasClass("disabled")) return false;
          self.location.href='a.php?restart';
        });

        $("#new-content-tag").focus(function() {
          $("#new-content-tag").removeClass('ui-autocomplete-loading');
        });

        $('#new-content-save').click(function() {
          if($(this).hasClass("disabled")) return false;
          $("#new-content-tag").show();
          $('#new-content-save').addClass('disabled').hide();
          $('#cke_new-content-html-c').show();
          saveContent();
        });
        
        $('#new-content-btn').click(function() {
          if($(this).hasClass("disabled")) return false;
          $(this).addClass("disabled");
          $("#new-content-tag").removeClass('ui-autocomplete-loading');
          $('#new-content-save').removeClass('disabled').show();
          $('#new-content').show();
          $("#new-content-tag").focus();
        });

        $('#new-content-cancel').click(function() {
          if($(this).hasClass("disabled")) return false;
          $("#new-content-type:selected").removeAttr("selected");
          $("#new-content-tag").removeClass('ui-autocomplete-loading');
          $("#new-content-tag").val("");
          $('#new-content-btn').removeClass("disabled")
          $('#new-content').hide();
        });

      });
      </script>

      <hr />

      <footer>
        <p>&copy; 2012 cmais+ O portal de conteúdo da Cultura</p>
      </footer>

      </div>
  </div>
  
</body>
</html>